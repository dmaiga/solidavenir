{% extends 'base.html' %}
{% load static humanize %}
{% load custom_filters %}
{% block title %}Solid'Avenir - Tableau de bord administrateur{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
<style>
    .dashboard-container {
        min-height: 80vh;
        padding: 2rem 0;
        background: #f8f9fa;
    }
    
    .dashboard-header {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        text-align: center;
        border-left: 4px solid var(--primary-color);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .stat-trend {
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .trend-up { color: var(--success-color); }
    .trend-down { color: var(--danger-color); }
    
    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: none;
    }
    
    .card-header {
        background: transparent;
        border-bottom: 1px solid #f1f3f4;
        padding: 1.5rem 1.5rem 0.5rem;
        font-weight: 600;
        color: var(--dark-color);
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
    
    .attention-item {
        padding: 1rem;
        border-left: 4px solid var(--warning-color);
        background: #fff3e0;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .transaction-item {
        padding: 1rem;
        border-left: 4px solid var(--primary-color);
        margin-bottom: 0.5rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .audit-item {
        padding: 0.75rem;
        border-left: 4px solid #6c757d;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        background: #f8f9fa;
        font-size: 0.9rem;
    }
    
    .badge-statut {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table th {
        background: var(--primary-color);
        color: white;
        font-weight: 600;
        border: none;
    }
    
    .table td {
        vertical-align: middle;
        border-color: #f1f3f4;
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
    }
    
    .progress-bar {
        border-radius: 4px;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-color);
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .quick-action {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        text-decoration: none;
        color: var(--dark-color);
        transition: all 0.3s ease;
    }
    
    .quick-action:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-decoration: none;
        color: var(--primary-color);
    }
    
    .quick-action-icon {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="dashboard-container">
    <div class="container">
        <!-- En-tête -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 fw-bold">Tableau de bord administrateur</h1>
                    <p class="text-muted mb-0">Aperçu complet de la plateforme Solid'Avenir</p>
                </div>
                <div class="text-end">
                    <p class="text-muted mb-0">Mise à jour: {{ aujourdhui|date:"d/m/Y" }}</p>
                    <small class="text-muted">Données en temps réel</small>
                </div>
            </div>
        </div>

<!-- Actions rapides -->
<div class="quick-actions">
    <!-- Projets en attente -->
    <a href="{% url 'admin:core_projet_changelist' %}?statut__exact=en_attente" class="quick-action">
        <div class="quick-action-icon">
            <i class="bi bi-clipboard-check"></i>
        </div>
        <div>Projets en attente</div>
        <small class="text-muted">{{ stats.projets_attente }} en attente</small>
    </a>
    
    <!-- Transactions à vérifier -->
    <a href="{% url 'admin:core_transaction_changelist' %}?statut__exact=en_attente" class="quick-action">
        <div class="quick-action-icon">
            <i class="bi bi-currency-exchange"></i>
        </div>
        <div>Transactions à vérifier</div>
        <small class="text-muted">{{ stats.transactions_attente }} en attente</small>
    </a>
    
    <!-- Porteurs de projet -->
    <a href="{% url 'admin:core_user_changelist' %}?user_type__exact=porteur" class="quick-action">
        <div class="quick-action-icon">
            <i class="bi bi-people"></i>
        </div>
        <div>Gérer les porteurs</div>
        <small class="text-muted">{{ stats.porteurs_total }} porteurs</small>
    </a>
    
    <!-- Logs d'audit - CORRIGÉ -->
    <a href="{% url 'admin:core_auditlog_changelist' %}" class="quick-action">
        <div class="quick-action-icon">
            <i class="bi bi-shield-check"></i>
        </div>
        <div>Logs d'audit</div>
        <small class="text-muted">Historique complet</small>
    </a>
</div>

        <!-- Statistiques principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.projets_total }}</div>
                <div class="stat-label">Projets totaux</div>
                <div class="stat-trend">
                    {{ stats.projets_actifs }} actifs • {{ stats.projets_attente }} en attente
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.utilisateurs_total }}</div>
                <div class="stat-label">Utilisateurs</div>
                <div class="stat-trend">
                    {{ stats.porteurs_total }} porteurs • {{ stats.donateurs_total }} donateurs
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.transactions_confirmees }}</div>
                <div class="stat-label">Dons confirmés</div>
                <div class="stat-trend trend-up">
                    {{ stats.dons_jour }} aujourd'hui
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.montant_total|floatformat:0|intcomma }}</div>
                <div class="stat-label">FCFA collectés</div>
                <div class="stat-trend trend-up">
                    {{ stats.montant_jour|floatformat:0|intcomma }} FCFA aujourd'hui
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Graphique des dons -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        Évolution des dons (30 derniers jours)
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="donsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Répartition des projets -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        Répartition des projets
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="projetsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Projets nécessitant attention -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-triangle"></i> Projets en attente de validation
                    </div>
                    <div class="card-body">
                        {% if projets_attention %}
                            {% for projet in projets_attention %}
                            <div class="attention-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ projet.titre }}</h6>
                                        <small class="text-muted">
                                            Par {{ projet.porteur.get_full_name|default:projet.porteur.username }}
                                            • {{ projet.date_creation|date:"d/m/Y" }}
                                        </small>
                                        <br>
                                        <strong>{{ projet.montant_demande|floatformat:0|intcomma }} FCFA</strong>
                                    </div>
                                    <a href="{% url 'valider_projet' projet.audit_uuid %}" class="btn btn-sm btn-primary">
                                        Examiner
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center">Aucun projet en attente de validation</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dernières transactions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> Dernières transactions
                    </div>
                    <div class="card-body">
                        {% for transaction in recent_transactions %}
                        <div class="transaction-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ transaction.montant|floatformat:0|intcomma }} FCFA</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ transaction.donateur_anonymise }}
                                        • {{ transaction.date_transaction|timesince }}
                                    </small>
                                </div>
                                <span class="badge bg-success">Confirmé</span>
                            </div>
                            <small class="text-muted">
                                Projet: {{ transaction.projet.titre|truncatewords:3 }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableaux supplémentaires -->
        <div class="row">
            <!-- Top donateurs -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Top donateurs</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Donateur</th>
                                        <th>Montant total</th>
                                        <th>Nombre de dons</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for donateur in top_donateurs %}
                                    <tr>
                                        <td>{{ donateur.get_full_name|default:donateur.username }}</td>
                                        <td>{{ donateur.total_dons|floatformat:0|intcomma }} FCFA</td>
                                        <td>{{ donateur.nombre_dons }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projets populaires -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Projets les plus financés</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Projet</th>
                                        <th>Collecté</th>
                                        <th>Objectif</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for projet in projets_populaires %}
                                    <tr>
                                        <td>{{ projet.titre|truncatewords:3 }}</td>
                                        <td>{{ projet.montant_collectes|floatformat:0|intcomma }} FCFA</td>
                                        <td>{{ projet.montant_demande|floatformat:0|intcomma }} FCFA</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs d'audit -->
        <div class="card">
            <div class="card-header">Dernières activités d'audit</div>
            <div class="card-body">
                {% for audit in recent_audits %}
                <div class="audit-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>{{ audit.get_action_display }}</strong> - {{ audit.modele }}
                            <br>
                            <small class="text-muted">
                                Par {{ audit.utilisateur.get_full_name|default:audit.utilisateur.username }}
                                • {{ audit.date_action|timesince }}
                            </small>
                        </div>
                        <small class="text-muted">{{ audit.date_action|date:"H:i" }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Graphique des dons
        const donsCtx = document.getElementById('donsChart').getContext('2d');
        new Chart(donsCtx, {
            type: 'line',
            data: {
                labels: {{ donnees_graphique.labels|safe }},
                datasets: [
                    {
                        label: 'Montant collecté (FCFA)',
                        data: {{ donnees_graphique.montants|safe }},
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Nombre de dons',
                        data: {{ donnees_graphique.nombre_dons|safe }},
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Montant (FCFA)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Nombre de dons'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // Graphique des projets par statut
        const projetsCtx = document.getElementById('projetsChart').getContext('2d');
        const statutColors = {
            'actif': 'rgb(16, 185, 129)',
            'en_attente': 'rgb(245, 158, 11)',
            'brouillon': 'rgb(59, 130, 246)',
            'termine': 'rgb(139, 92, 246)',
            'annule': 'rgb(239, 68, 68)',
            'rejete': 'rgb(156, 163, 175)'
        };

        new Chart(projetsCtx, {
            type: 'doughnut',
            data: {
                labels: {{ projets_par_statut|map_attribute:'statut'|safe }},
                datasets: [{
                    data: {{ projets_par_statut|map_attribute:'count'|safe }},
                    backgroundColor: {{ projets_par_statut|map_attribute:'statut'|safe }}.map(
                        statut => statutColors[statut] || 'rgb(156, 163, 175)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endblock %}