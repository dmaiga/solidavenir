{% extends 'base_admin.html' %}
{% load static humanize %}
{% load custom_filters %}
{% block title %}Solid'Avenir - Admin Dashboard{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
<style>
.dashboard-container {
    min-height: 80vh;
    padding: 1.5rem 0;
    background: #f8f9fa;
}

.dashboard-header {
    background: white;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.quick-links {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin: 1.5rem 0;
}

.quick-link {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.75rem;
    text-align: center;
    text-decoration: none;
    color: #2c3e50;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.quick-link:hover {
    border-color: #3498db;
    text-decoration: none;
    color: #3498db;
    transform: translateY(-1px);
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 1.5rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.priority-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.priority-card {
    background: white;
    border-radius: 8px;
    padding: 1.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    display: block;
    min-height: 120px;
}

.priority-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    text-decoration: none;
    color: inherit;
}

.priority-card.projects { border-left-color: #e74c3c; }
.priority-card.associations { border-left-color: #f39c12; }
.priority-card.milestones { border-left-color: #3498db; }
.priority-card.proofs { border-left-color: #9b59b6; }

.priority-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.priority-card.projects .priority-number { color: #e74c3c; }
.priority-card.associations .priority-number { color: #f39c12; }
.priority-card.milestones .priority-number { color: #3498db; }
.priority-card.proofs .priority-number { color: #9b59b6; }

.priority-label {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #2c3e50;
}

.priority-description {
    color: #6c757d;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-align: center;
    border-top: 3px solid #3498db;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: none;
    min-height: 200px; /* Ensure cards are always visible */
}

.card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem;
    font-weight: 600;
    color: #2c3e50;
    font-size: 1rem;
}

.card-body {
    padding: 1rem;
    min-height: 100px; /* Ensure card body has minimum height */
}

.empty-card-body {
    padding: 2rem;
    text-align: center;
    color: #6c757d;
}

.chart-container {
    position: relative;
    height: 200px;
    margin: 0.5rem 0;
}

.action-item {
    padding: 0.75rem;
    border-left: 3px solid;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    background: #f8f9fa;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: block;
}

.action-item:hover {
    background: #e9ecef;
    text-decoration: none;
    color: inherit;
}

.action-item.project { border-left-color: #e74c3c; }
.action-item.association { border-left-color: #f39c12; }
.action-item.milestone { border-left-color: #3498db; }
.action-item.proof { border-left-color: #9b59b6; }

/* Fixed progress bar styles */
.progress {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    margin: 0.5rem 0;
    overflow: visible;
}

.progress-bar {
    border-radius: 4px;
    font-size: 0.7rem;
    line-height: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    white-space: nowrap;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Ensure proper spacing between sections */
.row {
    margin-bottom: 1rem;
}

.col-lg-6, .col-lg-8, .col-lg-4, .col-md-6 {
    margin-bottom: 1rem;
}

/* Fix chart container spacing */
.card .chart-container {
    height: 180px;
}

/* Badge styles */
.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

@media (max-width: 768px) {
    .priority-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .priority-number {
        font-size: 1.75rem;
    }
    
    .chart-container {
        height: 160px;
    }
    
    .card {
        min-height: 180px;
    }
}
</style>

<div class="dashboard-container">
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 fw-bold">Admin Dashboard</h1>
                    <p class="text-muted mb-0">Priority actions and platform monitoring</p>
                </div>
                <div class="text-end">
                    <p class="text-muted mb-0">Last update: {{ aujourdhui|date:"m/d/Y" }}</p>
                    <small class="text-muted">Real-time data</small>
                </div>
            </div>
        </div>

        <!-- QUICK LINKS -->
        <div class="quick-links">
            <a href="{% url 'liste_membres' %}" class="quick-link">
                <i class="bi bi-people"></i><br>
                Manage Users
            </a>
            <a href="{% url 'liste_associations_admin' %}" class="quick-link">
                <i class="bi bi-building"></i><br>
                Associations
            </a>
            <a href="{% url 'logs_audit' %}" class="quick-link">
                <i class="bi bi-shield-check"></i><br>
                Audit Logs
            </a>
            <a href="{% url 'gerer_distributions' %}" class="quick-link">
                <i class="bi bi-cash-coin"></i><br>
                Distributions
            </a>
        </div>

        <!-- PRIORITY ACTIONS SECTION -->
        <h3 class="section-title">Priority Actions</h3>
        <div class="priority-grid">
            <!-- Associations to Validate -->
            <a href="{% url 'liste_associations_admin' %}?valide=false" class="priority-card associations">
                <div class="priority-number">{{ stats.associations_attente }}</div>
                <div class="priority-label">Associations Pending</div>
                <div class="priority-description">Associations requiring validation</div>
            </a>
            
            <!-- Milestones Reached -->
            <a href="{% url 'gerer_distributions' %}" class="priority-card milestones">
                <div class="priority-number">{{ stats.paliers_action }}</div>
                <div class="priority-label">Milestones Reached</div>
                <div class="priority-description">Ready for fund distribution</div>
            </a>
            
            <!-- Proofs to Verify -->
            <a href="#" class="priority-card proofs">
                <div class="priority-number">{{ stats.preuves_verification }}</div>
                <div class="priority-label">Proofs to Verify</div>
                <div class="priority-description">Milestone achievement proofs</div>
            </a>
        </div>

        <!-- OVERVIEW STATISTICS -->
        <h3 class="section-title">Platform Overview</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.projets_total }}</div>
                <div class="stat-label">Total Projects</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.utilisateurs_total }}</div>
                <div class="stat-label">Total Users</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.transactions_confirmees }}</div>
                <div class="stat-label">Confirmed Donations</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ stats.montant_total|floatformat:0|intcomma }}</div>
                <div class="stat-label">‚Ñè HBAR Raised</div>
            </div>
        </div>

        <!-- CHARTS AND ANALYTICS -->
        <h3 class="section-title">Charts and Analytics</h3>
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        üìà Donation Evolution (Last 15 days)
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="donsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        üé™ Project Distribution
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="projetsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIXED COLUMN - PROJECTS & ASSOCIATIONS -->
        <div class="row">
            <div class="col-lg-6">
                <!-- Projects Pending - ALWAYS VISIBLE -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üìã Projects Pending Validation</span>
                        <span class="badge bg-danger">{{ projets_attention|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if projets_attention %}
                            {% for projet in projets_attention %}
                            <a href="{% url 'valider_projet' projet.audit_uuid %}" class="action-item project">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ projet.titre }}</h6>
                                        <small class="text-muted">
                                            By {{ projet.porteur.get_full_name|default:projet.porteur.username }}
                                            ‚Ä¢ {{ projet.date_creation|date:"m/d/Y" }}
                                        </small>
                                        <br>
                                        <strong>{{ projet.montant_demande|floatformat:0|intcomma }} ‚Ñè HBAR</strong>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-check-circle text-success"></i>
                                <p class="mb-0">No projects pending validation</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Associations Pending - ALWAYS VISIBLE -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üèõÔ∏è Associations Pending</span>
                        <span class="badge bg-warning">{{ associations_attente|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if associations_attente %}
                            {% for association in associations_attente %}
                            <div class="action-item association">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ association.nom }}</h6>
                                        <small class="text-muted">
                                            {{ association.get_domaine_principal_display }}
                                            ‚Ä¢ {{ association.ville }}
                                            ‚Ä¢ {{ association.date_creation_profile|date:"m/d/Y" }}
                                        </small>
                                    </div>
                                    <div class="btn-group">
                                        <a href="{% url 'valider_association' association.id %}" class="btn btn-sm btn-success">
                                            ‚úì Validate
                                        </a>
                                        <a href="{% url 'preview_association_admin' association.id %}" target="_blank" class="btn btn-sm btn-info">
                                            üëÅÔ∏è Preview
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-check-circle text-success"></i>
                                <p class="mb-0">No associations pending validation</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN - MILESTONES & PROOFS -->
            <div class="col-lg-6">
                <!-- Milestones Reached - ALWAYS VISIBLE -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üéØ Milestones Reached</span>
                        <span class="badge bg-primary">{{ paliers_action|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if paliers_action %}
                            {% for item in paliers_action %}
                            {% with palier=item.palier %}
                            <a href="{% url 'gerer_distributions' %}?projet={{ palier.projet.id }}" class="action-item milestone">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ palier.projet.titre|truncatewords:4 }}</h6>
                                        <small class="text-muted">
                                            Milestone {{ palier.pourcentage }}% ‚Ä¢ 
                                            Raised: {{ item.montant_collecte|floatformat:0|intcomma }} ‚Ñè HBAR
                                        </small>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-primary" style="width: {{ item.pourcentage_atteint|floatformat:0 }}%">
                                                {{ item.pourcentage_atteint|floatformat:0 }}%
                                            </div>
                                        </div>
                                        <small class="text-muted">Amount to distribute: <strong>{{ palier.montant|floatformat:0|intcomma }} ‚Ñè HBAR</strong></small>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>
                            {% endwith %}
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-flag text-muted"></i>
                                <p class="mb-0">No milestones reached yet</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Proofs to Verify - ALWAYS VISIBLE -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üì∏ Proofs to Verify</span>
                        <span class="badge bg-purple">{{ preuves_a_verifier|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if preuves_a_verifier %}
                            {% for preuve in preuves_a_verifier %}
                            <a href="#" class="action-item proof">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ preuve.palier.projet.titre|truncatewords:4 }}</h6>
                                        <small class="text-muted">
                                            Milestone {{ preuve.palier.pourcentage }}% ‚Ä¢ 
                                            Submitted {{ preuve.date_soumission|date:"m/d/Y" }}
                                        </small>
                                        <br>
                                        <span class="badge {% if preuve.statut == 'en_attente' %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ preuve.get_statut_display }}
                                        </span>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-check-circle text-success"></i>
                                <p class="mb-0">No proofs to verify</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM SECTION - RECENT ACTIVITY -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        ‚ö° Recent Confirmed Transactions
                    </div>
                    <div class="card-body">
                        {% if recent_transactions %}
                            {% for transaction in recent_transactions %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div>
                                    <strong>{{ transaction.montant|floatformat:0|intcomma }} ‚Ñè HBAR</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ transaction.projet.titre|truncatewords:2 }}
                                    </small>
                                </div>
                                <small class="text-muted">{{ transaction.date_transaction|timesince }} ago</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-credit-card text-muted"></i>
                                <p class="mb-0">No recent transactions</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        üìã Recent Activities
                    </div>
                    <div class="card-body">
                        {% if recent_audits %}
                            {% for audit in recent_audits %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div>
                                    <small>
                                        <strong>{{ audit.get_action_display }}</strong> - {{ audit.modele }}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        {{ audit.utilisateur.get_full_name|default:audit.utilisateur.username }}
                                    </small>
                                </div>
                                <small class="text-muted">{{ audit.date_action|date:"H:i" }}</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-card-body">
                                <i class="bi bi-activity text-muted"></i>
                                <p class="mb-0">No recent activities</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Donation Chart
        const donsCtx = document.getElementById('donsChart').getContext('2d');
        new Chart(donsCtx, {
            type: 'line',
            data: {
                labels: {{ donnees_graphique.labels|safe }},
                datasets: [
                    {
                        label: 'Amount Raised (‚Ñè HBAR)',
                        data: {{ donnees_graphique.montants|safe }},
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Number of Donations',
                        data: {{ donnees_graphique.nombre_dons|safe }},
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Amount (‚Ñè HBAR)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Number of Donations'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // Projects Distribution Chart
        const projetsCtx = document.getElementById('projetsChart').getContext('2d');
        const statutColors = {
            'actif': 'rgb(16, 185, 129)',
            'en_attente': 'rgb(245, 158, 11)',
            'brouillon': 'rgb(59, 130, 246)',
            'termine': 'rgb(139, 92, 246)',
            'annule': 'rgb(239, 68, 68)',
            'rejete': 'rgb(156, 163, 175)'
        };

        new Chart(projetsCtx, {
            type: 'doughnut',
            data: {
                labels: {{ projets_par_statut|map_attribute:'statut'|safe }},
                datasets: [{
                    data: {{ projets_par_statut|map_attribute:'count'|safe }},
                    backgroundColor: {{ projets_par_statut|map_attribute:'statut'|safe }}.map(
                        statut => statutColors[statut] || 'rgb(156, 163, 175)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endblock %}