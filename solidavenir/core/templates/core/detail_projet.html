{% extends 'base.html' %}
{% load static %}

{% block title %}Solid'Avenir - {{ projet.titre }}{% endblock %}

{% block extra_css %}
<style>
    .project-hero {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    
    .project-image {
        height: 400px;
        object-fit: cover;
        border-radius: 10px;
        width: 100%;
    }
    
    .progress {
        height: 15px;
        border-radius: 10px;
        margin: 1.5rem 0;
    }
    
    .progress-bar-custom {
        transition: width 0.5s ease;
    }
    
    .stats-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .donation-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        position: sticky;
        top: 2rem;
    }
    
    .transaction-item {
        border-left: 4px solid var(--primary-color);
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    
    .category-badge {
        background: var(--secondary-color);
        color: var(--dark-color);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .btn-donation {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: transform 0.3s;
    }
    
    .btn-donation:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="project-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <span class="category-badge">Projet {{ projet.get_statut_display }}</span>
                <h1 class="display-4 fw-bold mb-3">{{ projet.titre }}</h1>
                <p class="lead">{{ projet.description|truncatewords:30 }}</p>
            </div>
            <div class="col-md-4 text-center">
                {% if projet.cover_image %}
<img src="{{ projet.cover_image.url }}" class="project-image" alt="{{ projet.titre }}">
{% elif projet.document_justificatif %}
<img src="{{ projet.document_justificatif.url }}" class="project-image" alt="{{ projet.titre }}">
{% else %}
<img src="{% static 'images/default-project-cover.jpg' %}" class="project-image" alt="{{ projet.titre }}">
{% endif %}
            </div>
        </div>
    </div>
</section>

<div class="container">
    <div class="row">
        <!-- Colonne principale -->
        <div class="col-lg-8">
            <!-- Barre de progression -->
            <div class="card stats-card">
                <div class="card-body">
                    <div class="progress">
                        <div class="progress-bar bg-success progress-bar-custom" 
                             role="progressbar" 
                             style='width: {{ pourcentage|default:0 }}%;'
                             aria-valuenow="{{ pourcentage|default:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-number">{{ projet.montant_collecte|default:0|floatformat:0 }}</div>
                            <div class="stat-label">FCFA collectés</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-number">{{ pourcentage|default:0 }}%</div>
                            <div class="stat-label">Objectif atteint</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-number">{{ projet.montant_demande|floatformat:0 }}</div>
                            <div class="stat-label">Objectif total</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description détaillée -->
            <div class="card stats-card">
                <div class="card-body">
                    <h3 class="mb-4">À propos du projet</h3>
                    <div class="project-description">
                        {{ projet.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Dernières transactions -->
            {% if transactions %}
            <div class="card stats-card">
                <div class="card-body">
                    <h3 class="mb-4">Derniers contributeurs</h3>
                    {% for transaction in transactions %}
                    <div class="transaction-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="text-primary">
                                    {% if transaction.don_anonyme %}
                                    Donateur anonyme
                                    {% else %}
                                    {{ transaction.donateur_anonymise }}
                                    {% endif %}
                                </strong>
                                <br>
                                <small class="text-muted">{{ transaction.date_transaction|date:"d/m/Y H:i" }}</small>
                            </div>
                            <span class="badge bg-success">{{ transaction.montant|floatformat:0 }} FCFA</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Informations porteur -->
            <div class="card stats-card">
                <div class="card-body">
                    <h3 class="mb-4">Porteur du projet</h3>
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5>{{ projet.porteur.get_full_name|default:projet.porteur.username }}</h5>
                            <p class="text-muted mb-1">
                                <i class="bi bi-building"></i> 
                                {{ projet.porteur.organisation|default:"Organisation non spécifiée" }}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="bi bi-calendar"></i> 
                                Projet créé le {{ projet.date_creation|date:"d/m/Y" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Formulaire de don -->
        <div class="col-lg-4">
            <div class="donation-card">
                <h3 class="text-center mb-4">Soutenir ce projet</h3>
                
                {% if projet.statut == 'actif' %}
                    {% if user.is_authenticated %}
                        {% if user.user_type == 'donateur' %}
                        <form method="post">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label for="{{ form.montant.id_for_label }}" class="form-label">
                                    Montant du don (FCFA)
                                </label>
                                {{ form.montant }}
                                {% if form.montant.errors %}
                                <div class="text-danger">{{ form.montant.errors }}</div>
                                {% endif %}
                                <div class="form-text">Montant minimum : 1 000 FCFA</div>
                            </div>
                            
                            <div class="mb-3 form-check">
                                {{ form.don_anonyme }}
                                <label class="form-check-label" for="{{ form.don_anonyme.id_for_label }}">
                                    Rendre mon don anonyme
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-donation w-100">
                                <i class="bi bi-heart-fill"></i> Faire un don
                            </button>
                        </form>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Seuls les donateurs peuvent effectuer des dons.
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="text-center">
                        <p>Connectez-vous pour soutenir ce projet</p>
                        <a href="{% url 'connexion' %}?next={% url 'detail_projet' projet.audit_uuid %}" 
                           class="btn btn-primary w-100 mb-2">
                            Se connecter
                        </a>
                        <a href="{% url 'inscription' %}" class="btn btn-outline-primary w-100">
                            Créer un compte
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Ce projet n'accepte plus de dons.
                    {% if projet.statut == 'termine' %}
                    Le projet a atteint son objectif de financement.
                    {% elif projet.statut == 'annule' %}
                    Le projet a été annulé.
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Informations de statut -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-2">Statut du projet</h6>
                    <div class="d-flex justify-content-between">
                        <span>Objectif :</span>
                        <strong>{{ projet.montant_demande|floatformat:0 }} FCFA</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Collecté :</span>
                        <strong>{{ projet.montant_collecte|default:0|floatformat:0 }} FCFA</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Reste à collecter :</span>
                        <strong>{{ projet.montant_restant|floatformat:0 }} FCFA</strong>
                    </div>
                </div>
            </div>

            <!-- Actions supplémentaires -->
            <div class="card stats-card mt-3">
                <div class="card-body text-center">
                    <h6>Partager ce projet</h6>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="#" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="#" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-twitter"></i>
                        </a>
                        <a href="#" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-whatsapp"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section projets similaires -->
{% if projets_similaires %}
<section class="container py-5">
    <h2 class="section-title text-center mb-4">Projets similaires</h2>
    <div class="row">
        {% for projet in projets_similaires %}
        <div class="col-md-4 mb-4">
            <div class="card project-card">
                {% if projet.document_justificatif %}
                <img src="{{ projet.document_justificatif.url }}" class="card-img-top" alt="{{ projet.titre }}" style="height: 200px; object-fit: cover;">
                {% else %}
                <img src="https://via.placeholder.com/300x200?text=Projet+Solid'Avenir" class="card-img-top" alt="{{ projet.titre }}" style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ projet.titre|truncatewords:5 }}</h5>
                    <p class="card-text">{{ projet.description|truncatewords:15 }}</p>
                    <a href="{% url 'detail_projet' projet.audit_uuid %}" class="btn btn-outline-primary btn-sm">Voir le projet</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animation de la barre de progression
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            const width = progressBar.style.width;
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = width;
            }, 500);
        }

        // Validation du formulaire de don
        const donationForm = document.querySelector('form');
        if (donationForm) {
            donationForm.addEventListener('submit', function(e) {
                const montantInput = document.getElementById('{{ form.montant.id_for_label }}');
                if (montantInput) {
                    const montant = parseFloat(montantInput.value);
                    if (montant < 1000) {
                        e.preventDefault();
                        alert('Le montant minimum de don est de 1 000 FCFA.');
                    }
                }
            });
        }

        // Partage sur les réseaux sociaux
        document.querySelectorAll('.btn-share').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const url = window.location.href;
                const title = document.title;
                
                if (this.classList.contains('btn-facebook')) {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                } else if (this.classList.contains('btn-twitter')) {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`, '_blank');
                } else if (this.classList.contains('btn-whatsapp')) {
                    window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
                }
            });
        });
    });
</script>
{% endblock %}